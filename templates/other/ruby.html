<h2>PerlユーザーがRubyユーザーに伝えたいこと ～ PerlとRubyの比較を通して</h2>

Perlユーザーとして、PerlとRubyを比較を通して、Rubyユーザーに伝えたいことを実名で書きます。匿名でPerlに対して書かれたネガティブな信頼性の低い記事がネット上に、あふれているからです。

<h2>「RubyからPerlへ」という記事でPerlの価値を落とさないで</h2>

Rubyの公式ドキュメントには、「間違いなく複雑」というPerlに対する誤解を招くネガティブなメッセージが含まれています。

<blockquote>
Perlはすばらしい言語です。ドキュメントもすばらしいし、Perlコミュニティもすばらしいコミュニティです。 しかし、<b>言語はかなり大きく、間違いなく複雑</b>です。

<a href="https://www.ruby-lang.org/ja/documentation/ruby-from-other-languages/to-ruby-from-perl/">RubyからPerlへ</a>
</blockquote>

Rubyの実装には、複雑さが少なく、Perlには多いような印象を、初見のユーザーに対して与えています。

Rubyの言語実装は小さく、Perlは大きいような印象を与えています。

<h3>Rubyの実装の複雑さ</h3>

ひとつの例として、PerlとRubyのGCの実装について考えてみましょう。

Perlは、<b>リファレンスカウントGC</b>と呼ばれるGCの実装を持っており、Rubyは、<b>世代別GC</b>というGCの実装を持っています。

さて、リファレンスカウントGCと世代別GCは、どちらの実装が複雑でしょうか。

一般的に理解されていることを、土台にすれば<b>世代別GCのほうが、実装が複雑</b>です。

リファレンスカウントGCのほうが、シンプルなのです。

このような一つの面を取り上げてみても、Rubyの公式ドキュメントが、Perlを複雑と一方的に語っているのは、不公平といえるでしょう。

Rubyのドキュメントは、Rubyが、複雑さの側面を持っているのに、まるでPerlだけが、複雑であるかの印象を与えています。

<h3>Rubyの言語の大きさ</h3>

Rubyは、バージョンを追うごとに、新機能が追加され続けてきました。Rubyは、言語機能が大きくなり続けています。

<ul>
  <li><a href="https://magazine.rubyist.net/articles/0041/0041-200Special-note.html">Ruby 2.0 新機能</a></li>
  <li><a href="https://techracho.bpsinc.jp/baba/2013_12_26/15026">Ruby 2.1 新機能</a></li>
  <li><a href="https://allabout.co.jp/gm/gc/452102/">Ruby 2.2 新機能</a></li>
  <li><a href="https://qiita.com/gipcompany/items/256a36ac727025f8f525">Ruby 2.3 新機能</a></li>
  <li><a href="https://qiita.com/jnchito/items/9f9d45581816f121af07">Ruby 2.4 新機能</a></li>
  <li><a href="https://qiita.com/jnchito/items/f182b6f0093a6a3701a1">Ruby 2.5 新機能</a></li>
  <li><a href="https://qiita.com/jnchito/items/ce11cb7fccdf4b66af24">Ruby 2.6 新機能</a></li>
  <li><a href="https://qiita.com/hanachin_/items/1aa1ba38a87dee91aed6">Ruby 2.7 新機能</a></li>
</ul>

一方Perlは、2002年Perl 5.8の時代に、言語機能をたくさん追加していく方針を転換しました。「もし、必要な機能があれば、モジュール(ライブラリ)において実装する」そういう方針への転換です。

Rubyのドキュメントは、Perlについて、まったく反対のことを語っています。

Perlは大きくなる速度をゆっくりさせたのに対して、Rubyは、言語の大きさを着実に増しているのです。

言語の大きさに関して、Rubyの公式ドキュメントは、Perlに関する正しい事実をユーザーへ伝えていません。

<h2>CSVを処理するRubyとPerlのソースコード</h2>

「Perlの文法はクズのようだ」

Rubyユーザーの皆様は、そう思っておられませんか。

では、実際に、Perlの文字列処理でCSVを処理するコードを、実際に見てみませんか?

<h3>Perlで標準入力から受け取ったCSVデータを、入力して、出力するサンプル</h3>

ファイルあるいは、標準入力から受け取ったCSVデータを、入力して、出力するサンプルです。Windowsで日本語対応。

<pre>
# Perlで標準入力から受け取ったCSVデータを、入力して、出力するサンプル

use strict;
use warnings;
use utf8;
use Encode 'encode', 'decode';

# コマンドライン引数、あるいは、標準入力から受け取る
while (my $line = <>) {
  # Perlの内部文字列にデコード
  $line = decode('cp932', $line);

  # 改行削除
  chomp $line;
  
  # split関数で分割して配列に代入
  my @items = split(/,/, $line);
  
  # join関数でタブ区切りでつなげる
  my $new_line = join("\t", @items);
  
  # 標準入力に出力
  print encode('cp932', $new_line) . "\n";
}
</pre>

どうでしょう。世間でPerlが、言われているような、可読性が皆無のクズみたいなコードでしょうか?

それとも「うーん、まぁ、普通」という感じですか?

実行はコマンドライン引数から受け取って

<pre>
perl script.pl foo.csv
</pre>

あるいは、標準入力から受け取って

<pre>
cat foo.csv | perl script.pl 
</pre>

ですね。

「あれ、Perlって、CSV処理するライブラリ、ついてないの。ついてないの小学生までだよねー」

なんて、思いませんでしたか?

<b>Perlの標準ライブラリの設計は、CPANをブートストラップできる小さな構成です。</b>

Perlのコア自体のライブラリを肥大化させず、Perlコア自体の開発者が、メンテナンスするコストを下げています。

Perlでは、CPANから、Text::CSVか、処理速度の速いText::CSV_XSを、ダウンロードすることができます。

<h3>RubyでCSVデータを、入力して、出力するサンプル</h3>

RubyのCSV処理のサンプルはこちら。Rubyには、最初からCSV処理ライブラリが、入っています。便利ですね。

<pre>
require 'csv'

csv_data = CSV.read('member.csv', headers: true)
puts "start..."

File.open("intro.txt", 'w') do |file|
  csv_data.each do |data|
    intro_msg = "#{data["club"]}クラブ所属の#{data["age"]}歳、#{data["name"]}です。\n"
    puts intro_msg
    file.write(intro_msg)
  end
end

puts "complete! See intro.txt."
</pre>

<a href="https://qiita.com/shizuma/items/7719172eb5e8c29a7d6e">Ruby CSVを扱うためのメモ</a>から引用させていただきました。ありがとうございます。

さて、PerlとRuby比べていかがですか?

Rubyの方が、10倍、きれいに楽しく書けますか?

それとも、まぁ、どっちもどっちでしょうか?

<h2>Ruby開発者からのPerlへの悪口はストップ</h2>

Rubyの作者のまつもとゆきひろ氏は、Perlのコアのコードを見て<b>「Perlは私が見たソースコードの中で最悪のソースコードです。」</b>と申しました。

また、PHPでは、プログラムはきれいに書けないとか、Javaではきれいに書けないとか、申しておりました。

Rubyのコミッター様のおひとりは、Perlに対して、PHPに対しても、Javaに対しても、C言語に対しても、攻撃を繰り広げておりました。

この方は「俺は、Rubyに対する批判もしているからOK」みたいな態度をとっておられますが、さて、いったいこれは、どうなのでしょうか。

読者の皆様は、Rubyは、過去に、全方位で、ネガティブキャンペーンを行っていたということを、知っておいてください。

さらに2019年、Rubyの開発者様は、Rubyが批判されたときに、「悪いところはPerlからとった」と申しました。

わたくし、これを見てショックを受けました。

しかし、それならば、Rubyの良いところは、どこからとったのでしょうか?

Rubyの楽しい機能を作成するために、参考したPerlの良い機能は、たくさんあるんじゃないでしょうか?

「俺がRailsを殺す」のように、すぐに「殺す」というような非倫理的な言葉を使ってしまう、Rubyコミッタの方もおられます。

「最悪」とか「殺す」とか、無料のオープンソースで、善意でボランティアで作成している作者の方への敬意はないのでしょうか?

<h2>RubyとPerlのWebフレームワークの比較</h2>

「Perlには代表的なWebフレームワークないしね」

そんな会話がRubyコミュニティで話されていませんか?

Rubyには「Ruby on Rails」と「Sinatra」という代表的なフレームワークがありますが、Perlには、何があるでしょう。

Rubyユーザーの皆様に知っていただくために、PerlのWebフレームワークをご紹介します。(50音順)

<ul>
  <li><a href="https://github.com/akimacho/wiki/wiki/Amon2">Amon2</a></li>
  <li><a href="https://codezine.jp/article/detail/4190">Catalyst</a></li>
  <li><a href="https://metacpan.org/pod/Dancer2">Dancer2</a></li>
  <li><a href="https://tutorial.perlzemi.com/blog/20140319139520.html">Mojolicious</a></li>
  <li><a href="https://gihyo.jp/dev/serial/01/perl-hackers-hub/000101">Plack/PSGI</a></li>
</ul>

Amon2は日本の開発者が開発しているフレームワークです。

ちなみに、わたくし、<a href="https://mojolicious.org/">Mojolicious</a>の開発チームに過去に参加していました。

Mojoliciousのテスティングフレームワークである、Test::Mojoは、わたくしが実装しました。

仲間とともに<a href="https://github.com/yuki-kimoto/mojolicious-guides-japanese/wiki">Mojoliciousの日本語への翻訳</a>もやっております。

Plack/PSGIというのは、RubyのRackに該当するミドルウェアです。

Perl/CGIは古いといわれ続けておりますが、実は、PerlのWebアプリ開発の主流は、CGIではありません。

Webサーバーを立てて、リバースプロキシ構成を使うのが、PerlのWeb開発の主流なのであります。

Rubyユーザーの知らないところで、PerlのWebフレームワークも発展しています。

またわたくしの開発しているCMSツール<a href="https://jp.giblog.net/">Giblog</a>もWebサイト・ブログを作成するのに便利でございます。

<h2>RubyとPerlのパフォーマンスの比較</h2>

ネットだけで情報を仕入れている皆様。Rubyは、Perlより速いと思っていませんか?

これは、半分は、本当で、半分は、間違えています。

<h3>一般的なベンチマークではRubyの方が速い</h3>

よくWeb上ではたくさんの言語を比較した、一般的なベンチマークが掲載されていますね。

再帰呼び出しや、数値計算など、一般的なベンチマークがあります。

それで、PerlとRubyを比較したときにRubyのほうが速いという結果が掲載されていますが、これは本当です。

PerlのVMは、抽象構文木を、直接実行しますが、RubyのVMは、バイトコードを生成して、それを実行します。

Perlのオペレーション実行のノードが、メモリ上で飛び飛びなのに対して、Rubyのバイトコードは、連続的にメモリ上に配置されています。

また、Rubyは、jump命令の実行を、分岐予測を使って、最適化するために、ダイレクトスレッディドコードになるように、最適化しています。

もう一つの理由は、PerlのGCが、リファレンスカウントGCなのに対して、RubyのGCは、世代別GCであるので、スループットは大きくなります。

また、Perlが数値と文字列を区別しないのに対して、Rubyは、数値と文字列を、区別していますから、型の判別という点でも、Perlよりも有利です。

「なんだー、Rubyの完全勝利じゃん」

そう思ったあなた、この話には続きがあります。

<h3>大量の文字列処理に最適化されたPerl</h3>

<b>Perlのパフォーマンスの最適化は、数値計算や再帰呼び出しに対してされているわけではなく、大量の文字列処理に対して、最適化されています。</b>

ですから、一般的なベンチマークでは、Perlは一見すると遅く見えます。

Perlは、リファレンスカウントGCを実装しており、スループットよりは、レイテンシ(応答時間)に対して最適化されています。

PerlのリファレンスカウントGCは、スコープの最後で、そのつどオブジェクトを解放するので、スループットは下がりますが、平均待ち時間は、良好です。

大量の文字列処理をする代表といえば、Webアプリケーションです。

2017年と少しだけ古いですが、Webフレームワークのパフォーマンス比較を見てください。わたくしが、少し前の調査で調べていたときに、見つけたものです。

PerlのMojoliciousという、プリフォーク + 非同期I/OのWebフレームワークが掲載されています。

Mojoliciousは、フルスタックのWebフレームワークです。RubyのフルスタックWebフレームワークであるRuby on Railsと比較してみてください。

<a href="https://www.techempower.com/benchmarks/#section=data-r14&hw=ph&test=query&d=1l">Webフレームワークのベンチマーク リクエストあたり20クエリでの1秒あたりのレスポンス 2017-05-10 ラウンド14</a>

<h2>RubyとPerlのメモリ使用率の比較</h2>

RubyとPerlでは、Perlの方がメモリ使用率は数分の1程度になるようです。

これは、実装について考えてみると理由は、わかります。

Rubyは、ソースコードを抽象構文木にコンパイルした後、さらに、それを解析して、最適化して、RubyのVMのバイトコードに変換して実行します。

Perlは、抽象構文木を生成したタイミングで、実行を開始しますから、バイトコード分のメモリを使わないです。

また、Rubyは、世代別GCを採用していますから、世代別GCを実行するための、新しいオブジェクトのエリアと古いオブジェクトのエリアを事前に確保しておく必要があります。

Perlの場合は、リファレンスカウントGCですから、メモリ生成のタイミングで、もしあらかじめとっているメモリのエリアが足りなくなれば、拡大するということで済みます。

この二つの理由で、Perlのメモリ使用率は、Rubyのメモリ使用率よりも小さくなります。

<h2>RubyとPerlの起動速度</h2>

小さなスクリプトを動かしているときは、ほぼ気にならないでしょう。

数千もの大量のライブラリを読み込んだときは、少し差が出るはずです。

でも、これはきっと、ほんの少し。

Rubyは、ソースコードを抽象構文木にコンパイルした後、さらに、それを解析して、最適化して、RubyのVMのバイトコードに変換して実行します。

Perlは、抽象構文木を生成したタイミングで、実行を開始します。

バイトコードへ変換処理をしない分だけPerlの方が速いですが、気にならないレベルでしょう。

<h2>Rubyのgemに該当するのは、Perlのcpan/cpanm</h2>

RubyにはRubyGemsというライブラリをWeb上に配置して、ダウンロードできる仕組みあります。

Perlにも、これに該当するCPANという仕組みがありますが、<b>RubyGemsはPerlのCPANが発明され成功した後に、それを参考に作られたものです。</b>

「RubyGemsすごい」は、「CPANすごい」にそのまま該当します。

Perlには、cpanの動作を軽くして、バージョン管理とCAPNに加えて、Githubからのインストールも可能なcpanmという優れたツールもあります。

RubyでBundlerを使ってバージョン管理できるように

cpanmを使えば、PerlのCPANモジュールのバージョン管理を行うことができます。

<h2>Perlの紹介を極端に避けるRubyユーザー</h2>

Rubyに限ったことではありませんが、Perlを参考にして作成された動的型付け言語のユーザーは、極端にPerlへの言及を避ける傾向にあります。

PHPユーザーは、RubyとJavaScriptとPythonを紹介し、

JavaScriptユーザーは、RubyとPythonとPHPを紹介し、

PHPユーザーは、RubyとJavaScriptとPythonを紹介し、

Rubyユーザーは、PythonとJavaScriptとPHP(?)を紹介します。

Perlから多くを参考にしている動的言語、スクリプト言語のユーザー様は、Perlをどうして極端に避けるのでしょうか?

「Perlは古い」「Perlは死んだ」「Perlはトレンドではない」「Perlユーザーは少ない」「Perlはこれから学ぶべきではない言語」

と考えているのでしょうか?

しかし、わたくし、Perlを現場で使って、開発しております。顧客に対してPerlでサービスを提供し、顧客と会社に対して利益を生み出しております。

現場で働く、わたくしの存在を、消してしまおうということですか?

Perlは、スクリプト言語の父や祖父のような存在であるのに、それを無視し、軽蔑しようとするのですか?

学生にPerlを過去のものと信じ込ませ、新規案件にPerlを採用をさせないことに、熱心なのですか?

こういうことをやめて、敬意をもって、公正な競争の元にPerlを置いていただけませんか?

<h2>Rubyユーザーを攻撃するgo、python、JavaScript、Rustユーザー</h2>

Webのてっぺんでは、10年前から、ずっと同じことが繰り返されています。

Rubyに愛着があり、Rubyで開発しているユーザーに対して、go、python、JavaScript、Rustユーザーは、ネット上でネガティブキャンペーンを繰り広げております。

「Rubyはチームを幸せにしない。これからは〇〇」という言葉を、残してRubyを去っていきます。

Rubyで作った収益がでているサービスを、自分たちの言語で、リプレースしようと、狙っています。

かつて、Railsは、WebのてっぺんをRailsへの賛美で埋め尽くしました。今度はPythonがWebと書店のてっぺんを賛美で埋め尽くしております。

Perlゼミは、こういう不公平で、不健全で、不毛な状況を改善したいと思っております。

Rubyユーザーの皆様は、気持ちがわかってきたと思うので、Perlに対して、やってきたことをどうか反省してください。

プログラミング言語のそれぞれのユーザーは、実際は、本当の加害者ではありません。

PerlやRubyを攻撃していたとしても、その人たちは、本当の意味での加害者ではありません。

<b>もっと上流から「権威と一時的な札束」を使って、エンジニアを分断させて、自分たちが独占的な利益を得るために、悪意を流している大元がいます。</b>

